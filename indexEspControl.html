<!DOCTYPE HTML>
<html>

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
        integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 120px;
            height: 68px
        }

        .switch input {
            display: none
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            border-radius: 34px
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 52px;
            width: 52px;
            left: 8px;
            bottom: 8px;
            background-color: #fff;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 68px
        }

        input:checked+.slider {
            background-color: #2196F3
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(52px);
            -ms-transform: translateX(52px);
            transform: translateX(52px)
        }
    </style>
</head>

<body>
    <h2>ESTUFAS</h2>
    <p></p>
    <div class="container-fluid">

        <div class="row">
            <div class="col-sm-3 col-lg-3">
                <button type="button" onclick="menuChange(this)" class="btn btn-lg btn-primary"
                    id="menumanualButtons">Modo
                    Manual</button>
            </div>
            <div class="col-sm-3 col-lg-3">
                <button type="button" onclick="menuChange(this)" class="btn btn-lg btn-primary" id="menucard1">Manual
                    temporizado</button>
            </div>

            <div class="col-sm-3 col-lg-3">
                <button type="button" onclick="menuChange(this)" class="btn btn-lg btn-primary"
                    id="menutimerTable">Programar
                    Relógio</button>
            </div>
            <div class="col-sm-3 col-lg-3">
                <button type="button" onclick="menuChange(this)" class="btn btn-lg btn-primary"
                    id="menucurrentState">Estado
                    Actual</button>
            </div>
        </div>

        <p></p>
        <p></p>

        <div class="row" id="main">


        </div>
    </div>

    <script>


        function toggleCheckbox(element) {
            var xhr = new XMLHttpRequest();
            if (element.checked) { xhr.open("GET", "/update?relay=" + element.id + "&state=1", true); }
            else { xhr.open("GET", "/update?relay=" + element.id + "&state=0", true); }
            xhr.send();
        }

        function checkSwitch() {
            $.ajax({
                url: "http://192.168.1.87/json",
                type: 'GET',
                dataType: 'json',
                success: function (results) { processResults(null, results) },
                error: function (request, statusText, httpError) { processResults(httpError || statusText), null }
            });

            function processResults(error, data) {
                if (error) {
                    console.log(error)
                }
                {
                    if (data) {
                        console.log(data.digital)
                    }
                }
            }
            document.getElementById("1").checked = 1;
            document.getElementById("2").checked = 0;
            document.getElementById("3").checked = 1;
            document.getElementById("4").checked = 0;
            document.getElementById("5").checked = 1;
        }

        function menuChange(element) {
            $("#main").empty();
            if (String(element.id).slice(4) == "timerTable") {
                $("#main").append(timerTable());
            }
            if (String(element.id).slice(4) == "card1") {
                $("#main").append(cards());
            }
            if (String(element.id).slice(4) == "manualButtons") {
                $("#main").append(manualButtons());
            }
            if (String(element.id).slice(4) == "currentState") {
                //$("#main").append(manualButtons());
            }
        }

        var countDownDate;
        var distance;

        function stopTimer() {
            countDownDate = new Date().getTime();
            $("#timerStart").attr("disabled", false);
            $("#timerValue").attr("disabled", false);
            $("#card1Body").attr("style", "background-color:Red;");

        }

        function startTimer() {
            // Set the date we're counting down to
            countDownDate = addMinutes(new Date(), $("#timerValue").val());
            setInterval(timer, 1000);
            $("#timerStart").attr("disabled", true);
            $("#timerValue").attr("disabled", true);
            $("#card1Body").attr("style", "background-color:MediumSeaGreen;");
        }

        function addMinutes(date, minutes) {
            return new Date(date.getTime() + minutes * 60000);
        }

        setInterval(checkSwitch, 5000)

        // Update the count down every 1 second
        function timer() {
            // Get today's date and time
            var now = new Date().getTime();
            // Find the distance between now and the count down date
            distance = countDownDate - now;
            // Time calculations minutes and seconds
            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);
            // Output the result in an element with id="countdown"
            document.getElementById("countdown").innerHTML = minutes + "m " + seconds + "s ";
            // If the count down is over, write some text 
            if (distance < 0) {
                clearInterval(timer);
                $("#timerStart").attr("disabled", false);
                $("#timerValue").attr("disabled", false);
                $("#card1Body").attr("style", "background-color:Red;");
                document.getElementById("countdown").innerHTML = "REGA PARADA";
            }
        }

        function timerTable() {
            var tableHTML =
                "<div class='col-sm-12 col-lg-12' id='timerTable'>"
                + "<table class='table table-bordered'>"
                + "<thead class='thead-dark'>"
                + "<tr>"
                + "<th scope='col' style='text-align:center'>Hora</th>"
                + "<th scope='col' style='text-align:center'>Estufa 1 </th>"
                + "<th scope='col' style='text-align:center'>Estufa 2</th>"
                + "<th scope='col' style='text-align:center'>Estufa 3</th>"
                + "<th scope='col' style='text-align:center'>Estufa 4</th>"
                + "</tr>"
                + "</thead>"
                + "<tbody>"
                + createRows()
                + "</tbody >"
                + "</table >"
                + "</div > ";

            function createRows() {
                var rowHTML = "";

                for (var h = 0; h < 24; h++) {
                    for (var m = 0; m < 50; m = m + 15) {
                        rowHTML = rowHTML + ("<tr>"
                            + "<th class='table-dark' scope='row' style='text-align:center'>" + h + "H " + m + "m</th>"
                            + "<td style='text-align:center;' onclick='toggleSchedule(this)' id='estufa:1:" + h + ":" + m + "'></td>"
                            + "<td style='text-align:center;' onclick='toggleSchedule(this)' id='estufa:2:" + h + ":" + m + "'></td>"
                            + "<td style='text-align:center;' onclick='toggleSchedule(this)' id='estufa:3:" + h + ":" + m + "'></td>"
                            + "<td style='text-align:center;' onclick='toggleSchedule(this)' id='estufa:4:" + h + ":" + m + "'></td>"
                            + "</tr>");
                    }
                }
                return rowHTML;
            }
            return tableHTML;
        }

        function toggleSchedule(form) {
            form.classList.toggle("bg-success");
            if (form.innerHTML === "REGAR") {
                form.innerHTML = "";
            } else {
                form.innerHTML = "REGAR";
            }
        }

        function manualButtons() {
            var buttons = "<div class='col-sm-12 col-lg-12' id='manualButtons'>";

            for (var i = 1; i <= 5; i++) {
                buttons += "<h4>Relay #" + i + " - GPIO " + "</h4>"
                    + "<label class='switch'><input type='checkbox' onchange='toggleCheckbox(this)'"
                    + "id='" + i + "''>"
                    + "<span class='slider'></span></label>";
            }
            buttons += "</div>";
            return buttons;
        }

        function cards() {
            var cards = "<div class='row' id='cards'>";
            for (var xcard = 1; xcard <= 4; xcard++) {
                cards += createCard(xcard);
            }
            cards += "</div>";
            return cards;
        }

        function createCard(number) {
            var card = "<div class='col-sm-12 col-lg-6'>";

            card += "<div class='card m-3' id='card" + number + "'> "
                + "<div class='card-body' style='background-color: Red;' id='card" + number + "Body'> "
                + "<h2 class='card-title text-center'>ESTUFA " + number + "</h2>"
                + "<p class='card-text text-center' id='countdown" + number + "'>REGA PARADA</p>"
                + "</div>"
                + "<ul class='list-group list-group - flush' style='background-color: DodgerBlue; '>"
                + "<li class='list-group-item' style='background-color: rgb(0, 186, 255); '>"
                + "<div class='form-group' style='background-color: rgb(0, 186, 255); '>"
                + "<label for='exampleFormControlSelect1'>Tempo de rega 'MINUTOS'</label>"
                + "<select class='form-control' id='timerValue' name='valueTimerValue'>"
                + "<option>5</option><option>10</option><option>15</option>"
                + "<option>20</option><option>25</option><option>30</option>"
                + "</select>"
                + "</div>"
                + "</li>"
                + "</ul>"
                + "<div class='card-body' style='background-color: rgb(0, 186, 255); '>"
                + "<button type='button' onclick='startTimer()' class='btn btn-lg btn-success'"
                + " id='timerStart'>Começar Rega</button > "
                + "<button type='button' onclick='stopTimer()' class='btn btn-lg btn-danger' "
                + "id='timerStop'>Parar Rega</button>"
                + "</div>"
                + "</div>";

            card += "</div>";
            return card;
        }

    </script>

</body>

</html>